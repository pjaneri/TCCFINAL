
/**
 * @file Overview
 * This ruleset enforces a strict user-ownership model for most data, with public read access for rewards.
 * Points are awarded immediately upon logging a recycling record.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profile information. Users can only read/write their own profile.
 * - /users/{userId}/recycling_records/{recordId}: Stores recycling records. Owner can create and delete.
 * - /users/{userId}/redemptions/{redemptionId}: Stores redemption records. Only the owner can read/write.
 * - /rewards/{rewardId}: Stores reward information. Publicly readable.
 *
 * Key Security Decisions:
 * - User data is private. Listing other users is not allowed.
 * - The /rewards collection is publicly readable.
 * - Admin roles have been removed for simplicity.
 * - Recycling records grant points immediately, removing the need for an approval/validation step.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the current user is signed in.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the user ID matches the authenticated user's ID.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the user is an existing owner of a document.
     */
    function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
    }

    /**
     * @description Enforces user-level access control for profiles.
     * @path /users/{userId}
     * @allow (get) User can read their own profile.
     * @allow (create) User can create their own profile.
     * @allow (update) User can update their own profile.
     * @deny Reading, listing, or writing profiles of other users.
     */
    match /users/{userId} {
      allow get, list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update, delete: if isExistingOwner(userId);
    }

    /**
     * @description Enforces access control for recycling records.
     * @path /users/{userId}/recycling_records/{recordId}
     * @allow (read, list, create, delete) Owner can manage their own records.
     * @deny (update) Records are immutable after creation.
     */
    match /users/{userId}/recycling_records/{recordId} {
      allow get, list, create, delete: if isOwner(userId);
      allow update: if false;
    }

    /**
     * @description Allows public read access to rewards.
     * @path /rewards/{rewardId}
     * @allow (get, list) Any user can read rewards.
     * @deny (write) Rewards are read-only for clients.
     */
    match /rewards/{rewardId} {
      allow get, list: if true;
      allow write: if false;
    }

    /**
     * @description Enforces user-level access control for redemptions.
     * @path /users/{userId}/redemptions/{redemptionId}
     * @allow (read, create, delete) Only the owner can manage their redemptions.
     * @deny (update) Redemptions are immutable.
     */
    match /users/{userId}/redemptions/{redemptionId} {
      allow read, create, delete: if isOwner(userId);
      allow list: if isOwner(userId);
      allow update: if false;
    }

    // Deprecated collections - deny all access
    match /roles_admin/{doc=**} {
      allow read, write: if false;
    }
    match /recycling_records_all/{doc=**} {
      allow read, write: if false;
    }
  }
}
